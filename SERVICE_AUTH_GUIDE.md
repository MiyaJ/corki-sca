# å¾®æœåŠ¡å†…å¤–ç½‘éš”ç¦»å®æ–½æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æ›´æ–°æ—¥æœŸ**: 2025-12-25
> **ç›®æ ‡**: åŸºäº Sa-Token å®ç°å¾®æœåŠ¡å†…å¤–ç½‘éš”ç¦»å’ŒæœåŠ¡é—´è®¤è¯

---

## ğŸ“ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤–éƒ¨ç”¨æˆ·                               â”‚
â”‚            (User Token: Admin-Token / Member-Token)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Spring Cloud Gateway (ç½‘å…³)                        â”‚
â”‚  1. ç”¨æˆ·è®¤è¯å±‚ï¼šéªŒè¯ Admin-Token / Member-Token                â”‚
â”‚  2. Tokenè½¬æ¢å±‚ï¼šè½¬æ¢ä¸º Internal-Token                          â”‚
â”‚  3. ä¿¡æ¯ä¼ é€’å±‚ï¼šé™„åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å†…éƒ¨å¾®æœåŠ¡é›†ç¾¤ (Admin/Member/Product/...)          â”‚
â”‚  1. æœåŠ¡è®¤è¯å±‚ï¼šéªŒè¯ Internal-Token                            â”‚
â”‚  2. æƒé™æ§åˆ¶å±‚ï¼šæ‹’ç»éæ³•ç›´æ¥è®¿é—®                                â”‚
â”‚  3. ç”¨æˆ·ä¿¡æ¯æå–ï¼šè·å–åŸå§‹ç”¨æˆ·ä¸Šä¸‹æ–‡                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sa-Token å¤šè´¦å·ä½“ç³»

| å·¥å…·ç±» | ç”¨é€” | loginType | Tokenåç§° |
|--------|------|-----------|-----------|
| `StpAdminUtil` | ç®¡ç†åå°ç”¨æˆ·è®¤è¯ | `admin` | `satoken-admin` |
| `StpMemberUtil` | ä¼šå‘˜ç«¯ç”¨æˆ·è®¤è¯ | `member` | `satoken-member` |
| `StpInternalUtil` | å†…éƒ¨æœåŠ¡è®¤è¯ | `internal` | `satoken-internal` |

---

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šé…ç½®å„å¾®æœåŠ¡å¯ç”¨æœåŠ¡è®¤è¯

åœ¨æ¯ä¸ªå¾®æœåŠ¡çš„ `application.yml` æˆ– Nacos é…ç½®ä¸­æ·»åŠ ï¼š

```yaml
# æœåŠ¡é—´è®¤è¯é…ç½®
service:
  auth:
    enabled: true        # å¯ç”¨æœåŠ¡é—´è®¤è¯
    timeout: 2592000     # Tokenæœ‰æ•ˆæœŸï¼ˆ30å¤©ï¼‰
    strict-mode: true    # ä¸¥æ ¼æ¨¡å¼ï¼ˆæ‹’ç»éæ³•è¯·æ±‚ï¼‰

spring:
  application:
    name: corki-sca-admin  # æœåŠ¡åç§°ï¼Œä½œä¸ºTokençš„å”¯ä¸€æ ‡è¯†
```

**éœ€è¦é…ç½®çš„æœåŠ¡**ï¼š
- âœ… `corki-sca-admin` (ç®¡ç†åå°)
- âœ… `corki-sca-member` (ä¼šå‘˜æœåŠ¡)
- âœ… `corki-sca-product` (å•†å“æœåŠ¡)
- âœ… `corki-sca-order` (è®¢å•æœåŠ¡)
- âœ… `corki-sca-pay` (æ”¯ä»˜æœåŠ¡)

**æ³¨æ„**ï¼šç½‘å…³æœåŠ¡ä¹Ÿéœ€è¦é…ç½®ï¼Œä½†ä¸éœ€è¦å¯ç”¨æ‹¦æˆªå™¨ï¼ˆå› ä¸ºç½‘å…³æ˜¯è®¤è¯è¾¹ç•Œï¼‰ã€‚

---

### ç¬¬äºŒæ­¥ï¼šç½‘å…³é…ç½®

ç½‘å…³çš„é…ç½®ï¼ˆå·²è‡ªåŠ¨å®Œæˆï¼‰ï¼š

1. **å¯ç”¨å†…éƒ¨è®¤è¯è½¬å‘**
   ```yaml
   service:
     auth:
       enabled: true  # ç½‘å…³ä¹Ÿéœ€è¦å¯ç”¨
   ```

2. **è¿‡æ»¤å™¨è‡ªåŠ¨å·¥ä½œ**
   - `InternalAuthForwardFilter` ä¼šè‡ªåŠ¨ï¼š
     - éªŒè¯ç”¨æˆ·Tokenï¼ˆAdmin/Memberï¼‰
     - é™„åŠ å†…éƒ¨Tokenï¼ˆInternalï¼‰
     - ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼ˆX-User-Type, X-User-Idï¼‰

---

### ç¬¬ä¸‰æ­¥ï¼šæœåŠ¡å¯åŠ¨éªŒè¯

å¯åŠ¨æœåŠ¡åï¼Œè§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š

```log
===========================================
æœåŠ¡é—´è®¤è¯åˆå§‹åŒ–æˆåŠŸ
æœåŠ¡åç§°: corki-sca-admin
å†…éƒ¨Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Tokenæœ‰æ•ˆæœŸ: 2592000 ç§’
===========================================
```

**æ£€æŸ¥é¡¹**ï¼š
- [ ] å„æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨è·å–å†…éƒ¨Token
- [ ] ç½‘å…³å¯åŠ¨æ—¶è·å–ç½‘å…³å†…éƒ¨Token
- [ ] æ—¥å¿—ä¸­æ˜¾ç¤º "æœåŠ¡é—´è®¤è¯æ‹¦æˆªå™¨å·²å¯ç”¨"

---

## ğŸ” å®‰å…¨æœºåˆ¶è¯´æ˜

### 1. ä¸‰å±‚é˜²æŠ¤ä½“ç³»

| å±‚çº§ | é˜²æŠ¤å¯¹è±¡ | é˜²æŠ¤æ‰‹æ®µ |
|------|----------|----------|
| **ç¬¬ä¸€å±‚** | å¤–éƒ¨ç”¨æˆ· | ç½‘å…³éªŒè¯ Admin-Token / Member-Token |
| **ç¬¬äºŒå±‚** | æœåŠ¡è°ƒç”¨ | å†…éƒ¨æœåŠ¡éªŒè¯ Internal-Token |
| **ç¬¬ä¸‰å±‚** | æ•°æ®æƒé™ | ä¸šåŠ¡å±‚é¢çš„æƒé™æ§åˆ¶ |

### 2. è¯·æ±‚å¤´ä¼ é€’

ç½‘å…³è½¬å‘è¯·æ±‚æ—¶ä¼šé™„åŠ ä»¥ä¸‹è¯·æ±‚å¤´ï¼š

```http
X-Internal-Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-User-Type: admin
X-User-Id: 1001
X-Token-Name: satoken-admin
```

### 3. ç™½åå•æœºåˆ¶

ä»¥ä¸‹è·¯å¾„ä¸éœ€è¦å†…éƒ¨è®¤è¯ï¼š

- `/login/**` - ç™»å½•æ¥å£
- `/admin/login/**` - ç®¡ç†åå°ç™»å½•
- `/member/login/**` - ä¼šå‘˜ç™»å½•
- `/actuator/**` - å¥åº·æ£€æŸ¥
- `/doc.html`, `/webjars/**` - APIæ–‡æ¡£

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šæ­£å¸¸ç”¨æˆ·è¯·æ±‚

```bash
# 1. ç”¨æˆ·ç™»å½•è·å–Token
curl -X POST http://localhost:10006/admin/login/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123",
    "code": "1234",
    "uuid": "test-uuid"
  }'

# è¿”å›ç”¨æˆ·Token
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "tokenValue": "user-token-xyz",
    ...
  }
}

# 2. ä½¿ç”¨ç”¨æˆ·Tokenè®¿é—®ä¸šåŠ¡æ¥å£
curl http://localhost:10006/admin/system/user/list \
  -H "satoken: user-token-xyz"

# æˆåŠŸè¿”å›æ•°æ®
```

### æµ‹è¯•åœºæ™¯2ï¼šç›´æ¥è®¿é—®å†…éƒ¨æœåŠ¡ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰

```bash
# ä¸é€šè¿‡ç½‘å…³ï¼Œç›´æ¥è®¿é—®å†…éƒ¨æœåŠ¡
curl http://localhost:10001/admin/system/user/list

# é¢„æœŸç»“æœï¼ˆä¸¥æ ¼æ¨¡å¼ä¸‹ï¼‰ï¼š
{
  "code": 401,
  "message": "éæ³•è®¿é—®ï¼šç¼ºå°‘å†…éƒ¨è®¤è¯ä¿¡æ¯",
  "data": null
}
```

### æµ‹è¯•åœºæ™¯3ï¼šæœåŠ¡é—´è°ƒç”¨

```bash
# æœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼ˆé€šè¿‡Feignï¼‰
# ç½‘å…³ä¼šè‡ªåŠ¨é™„åŠ Internal-Token
# æœåŠ¡Bçš„æ‹¦æˆªå™¨ä¼šéªŒè¯Token

# æˆåŠŸè¿”å›æ•°æ®
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

**ç½‘å…³æ—¥å¿—**ï¼š
```log
2025-12-25 10:30:15 DEBUG 12345 --- [ctor-http-nio-2] c.c.g.filter.InternalAuthForwardFilter : æå–ç®¡ç†åå°ç”¨æˆ·ä¿¡æ¯: userId=1001
2025-12-25 10:30:15 DEBUG 12345 --- [ctor-http-nio-2] c.c.g.filter.InternalAuthForwardFilter : é™„åŠ ç½‘å…³å†…éƒ¨Token
```

**å†…éƒ¨æœåŠ¡æ—¥å¿—**ï¼š
```log
2025-12-25 10:30:15 DEBUG 12346 --- [nio-10001-exec-1] c.c.c.i.ServiceAuthInterceptor : æœåŠ¡é—´è®¤è¯é€šè¿‡ - URI: /admin/system/user/list
2025-12-25 10:30:15 DEBUG 12346 --- [nio-10001-exec-1] c.c.c.i.ServiceAuthInterceptor : æå–ç”¨æˆ·ä¿¡æ¯ - ç±»å‹: admin, ç”¨æˆ·ID: 1001
```

### å¼‚å¸¸æƒ…å†µæ—¥å¿—

**ç¼ºå°‘Token**ï¼š
```log
2025-12-25 10:35:00 WARN 12346 --- [nio-10001-exec-2] c.c.c.i.ServiceAuthInterceptor : ç¼ºå°‘å†…éƒ¨Token - URI: /admin/system/user/list, IP: 192.168.1.100
```

**Tokenæ— æ•ˆ**ï¼š
```log
2025-12-25 10:36:00 WARN 12346 --- [nio-10001-exec-3] c.c.c.i.ServiceAuthInterceptor : å†…éƒ¨Tokenæ— æ•ˆ - URI: /admin/system/user/list, Token: ab12****ef34
```

---

## âš™ï¸ é«˜çº§é…ç½®

### 1. å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆå®½æ¾æ¨¡å¼ï¼‰

```yaml
service:
  auth:
    enabled: false         # å…³é—­è®¤è¯
    strict-mode: false     # éä¸¥æ ¼æ¨¡å¼
```

### 2. ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰

```yaml
service:
  auth:
    enabled: true          # å¿…é¡»å¯ç”¨
    strict-mode: true      # å¿…é¡»ä¸¥æ ¼
    timeout: 86400         # 1å¤©æœ‰æ•ˆæœŸï¼Œæé«˜å®‰å…¨æ€§
```

### 3. ä¸åŒæœåŠ¡é…ç½®ä¸åŒæœ‰æ•ˆæœŸ

```yaml
# æ ¸å¿ƒæœåŠ¡ï¼ˆè®¢å•ã€æ”¯ä»˜ï¼‰- çŸ­æœŸæœ‰æ•ˆ
service:
  auth:
    timeout: 3600  # 1å°æ—¶

# æ™®é€šæœåŠ¡ï¼ˆå•†å“ã€ä¼šå‘˜ï¼‰- é•¿æœŸæœ‰æ•ˆ
service:
  auth:
    timeout: 2592000  # 30å¤©
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥

**ç°è±¡**ï¼š
```log
Error creating bean with name 'serviceAuthConfig': Requested bean is currently in creation
```

**åŸå› **ï¼šSa-Token å’Œ Redisson é…ç½®å†²çª

**è§£å†³**ï¼š
- ç¡®ä¿ `RedissonConfig` æœ‰ `@Primary` æ³¨è§£
- æ£€æŸ¥ `corki-sca-common` ä¾èµ–æ­£ç¡®

### é—®é¢˜2ï¼šè¯·æ±‚è¢«æ‹’ç»

**ç°è±¡**ï¼š
```log
éæ³•è®¿é—®ï¼šç¼ºå°‘å†…éƒ¨è®¤è¯ä¿¡æ¯
```

**åŸå› **ï¼šæœªæ­£ç¡®é…ç½®ç½‘å…³æˆ–æœåŠ¡æœªå¯ç”¨è®¤è¯

**è§£å†³**ï¼š
1. æ£€æŸ¥ç½‘å…³ `InternalAuthForwardFilter` æ˜¯å¦æ­£å¸¸å·¥ä½œ
2. æ£€æŸ¥æœåŠ¡ `service.auth.enabled` æ˜¯å¦ä¸º `true`
3. æŸ¥çœ‹ç½‘å…³æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦é™„åŠ äº† `X-Internal-Token`

### é—®é¢˜3ï¼šTokenéªŒè¯å¤±è´¥

**ç°è±¡**ï¼š
```log
éæ³•è®¿é—®ï¼šå†…éƒ¨è®¤è¯ä¿¡æ¯æ— æ•ˆ
```

**åŸå› **ï¼šTokenè¿‡æœŸæˆ–æœåŠ¡é‡å¯åTokenä¸¢å¤±

**è§£å†³**ï¼š
1. æ£€æŸ¥ `service.auth.timeout` é…ç½®
2. æœåŠ¡é‡å¯åTokenä¼šé‡æ–°ç”Ÿæˆï¼Œç½‘å…³éœ€è¦åˆ·æ–°Token
3. è€ƒè™‘å°†TokenæŒä¹…åŒ–åˆ°é…ç½®ä¸­å¿ƒ

---

## ğŸ“ ä»£ç ç¤ºä¾‹

### è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

åœ¨ä»»ä½•ä¸šåŠ¡ä»£ç ä¸­ï¼Œå¯ä»¥è¿™æ ·è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š

```java
@Service
public class OrderServiceImpl {

    public void createOrder(OrderDTO orderDTO) {
        // æ–¹å¼1ï¼šä»ThreadLocalè·å–ï¼ˆç”±æ‹¦æˆªå™¨è®¾ç½®ï¼‰
        String userType = ServiceAuthInterceptor.UserContext.getUserType();
        String userId = ServiceAuthInterceptor.UserContext.getUserId();

        log.info("å½“å‰ç”¨æˆ· - ç±»å‹: {}, ID: {}", userType, userId);

        // æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨Sa-Tokenå·¥å…·ç±»
        if ("admin".equals(userType)) {
            Long adminUserId = StpAdminUtil.getLoginIdAsLong();
            // ç®¡ç†åå°é€»è¾‘
        } else if ("member".equals(userType)) {
            Long memberUserId = StpMemberUtil.getLoginIdAsLong();
            // ä¼šå‘˜ç«¯é€»è¾‘
        }
    }
}
```

### Feign æœåŠ¡é—´è°ƒç”¨

Feign è°ƒç”¨ä¼šè‡ªåŠ¨é€šè¿‡ç½‘å…³ï¼Œç½‘å…³ä¼šè‡ªåŠ¨é™„åŠ å†…éƒ¨Tokenï¼š

```java
@FeignClient(name = "corki-sca-product")
public interface ProductFeignApi {

    @GetMapping("/product/info/{id}")
    R<ProductDTO> getProductInfo(@PathVariable("id") Long id);
}
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. Tokenæœ‰æ•ˆæœŸç®¡ç†

- **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨ `-1`ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰ï¼Œæ–¹ä¾¿è°ƒè¯•
- **æµ‹è¯•ç¯å¢ƒ**ï¼šä½¿ç”¨ `86400`ï¼ˆ1å¤©ï¼‰
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ `3600`ï¼ˆ1å°æ—¶ï¼‰æˆ–æ›´çŸ­

### 2. ä¸¥æ ¼æ¨¡å¼æ§åˆ¶

- **å¼€å‘ç¯å¢ƒ**ï¼š`strict-mode: false`ï¼Œå…è®¸çµæ´»æ€§
- **ç”Ÿäº§ç¯å¢ƒ**ï¼š`strict-mode: true`ï¼Œç¡®ä¿å®‰å…¨

### 3. ç½‘å…³ç™½åå•

åªå¼€æ”¾å¿…è¦çš„è·¯å¾„åˆ°ç™½åå•ï¼Œå…¶ä»–è·¯å¾„å¿…é¡»ç»è¿‡è®¤è¯ã€‚

### 4. æ—¥å¿—çº§åˆ«

- **å¼€å‘ç¯å¢ƒ**ï¼š`DEBUG` çº§åˆ«ï¼ŒæŸ¥çœ‹è¯¦ç»†è®¤è¯è¿‡ç¨‹
- **ç”Ÿäº§ç¯å¢ƒ**ï¼š`WARN` çº§åˆ«ï¼Œåªè®°å½•å¼‚å¸¸æƒ…å†µ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [CLAUDE.md](./CLAUDE.md) - é¡¹ç›®æ¶æ„è¯´æ˜
- [DEVELOPMENT_PLAN.md](./DEVELOPMENT_PLAN.md) - å¼€å‘è®¡åˆ’
- [IMPLEMENTATION_GUIDE.md](./IMPLEMENTATION_GUIDE.md) - å®æ–½æŒ‡å—
- [Sa-Tokenå®˜æ–¹æ–‡æ¡£](https://sa-token.cc/)

---

**æœ€åæ›´æ–°**: 2025-12-25
**ç»´æŠ¤è€…**: Corki Team
**è”ç³»æ–¹å¼**: é¡¹ç›®Issues
